<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciador de Eventos - Porto Mais</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet" />
  <link href="assets/styles.css" rel="stylesheet" />

  <style>
    @keyframes shimmer { 0%,100%{background-position:200% center;} 50%{background-position:-200% center;} }
    @keyframes pulse-glow { 0%,100%{box-shadow:0 0 20px rgba(59,130,246,0.3);} 50%{box-shadow:0 0 30px rgba(59,130,246,0.6);} }
    @keyframes float { 0%,100%{transform:translateY(0px);} 50%{transform:translateY(-6px);} }
    @keyframes countUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .layout { display: flex; height: 100vh; overflow: hidden; }

    /* Menu reduzido - apenas 4 √≠cones SEM LOGO */
    .sidebar { width: 60px; background: linear-gradient(180deg, #002B5C 0%, #001b3a 100%); color: #fff; flex-shrink: 0; display: flex; flex-direction: column; position: relative; transition: width .2s ease; }

    .sidebar .menu { padding: 10px; padding-top: 20px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
    .sidebar .item { display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius: 12px; cursor:pointer; font-size:24px; color: rgba(255,255,255,.88); transition: all .15s ease; margin:0 auto; }
    .sidebar .item:hover { background: rgba(255,255,255,.10); transform: scale(1.1); }
    .sidebar .item.active { background: rgba(255,255,255,.16); color:#fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

    .sidebar .footer { margin-top:auto; padding: 12px; border-top: 1px solid rgba(255,255,255,.08); text-align:center; }
    .sidebar .footer .badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 999px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; display:inline-block; }

    .content { flex:1; background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%); overflow:auto; }

    .topbar { position: sticky; top:0; z-index: 50; background: rgba(255,255,255,.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,.06); padding: 14px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 2px 12px rgba(0,0,0,.04); }
    .badge { font-size: 12px; font-weight: 800; padding: 6px 12px; border-radius: 999px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; box-shadow:0 4px 12px rgba(102,126,234,.3); }

    .page { display:none; padding: 24px; animation: pageIn .35s ease both; }
    .page.active { display:block; }
    @keyframes pageIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

    .card { background:#fff; border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,.06); transition:transform .2s ease, box-shadow .2s ease; border:1px solid rgba(0,0,0,.04); }
    .card:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,.1); }

    .kpi-card { background:linear-gradient(135deg, #fff 0%, #f8f9ff 100%); border-radius:16px; padding:20px; cursor:pointer; user-select:none; transition:all .25s cubic-bezier(.4,0,.2,1); border-left:4px solid; position:relative; overflow:hidden; }
    .kpi-card::before { content:''; position:absolute; top:0; right:0; width:80px; height:80px; background:radial-gradient(circle, rgba(255,255,255,.4) 0%, transparent 70%); border-radius:50%; transform:translate(30%,-30%); }
    .kpi-card:hover { transform:translateY(-4px) scale(1.02); box-shadow:0 16px 40px rgba(0,0,0,.12); }
    .kpi-card:active { transform:translateY(-2px) scale(1.01); }
    .kpi-label { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#64748b; margin-bottom:8px; }
    .kpi-value { font-size:32px; font-weight:900; margin-bottom:4px; background:linear-gradient(135deg, #1e293b 0%, #475569 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:countUp .6s ease-out; }
    .kpi-sub { font-size:11px; color:#94a3b8; font-weight:600; }

    .chart-card { background:#fff; border-radius:20px; padding:24px; box-shadow:0 8px 30px rgba(0,0,0,.08); border:1px solid rgba(0,0,0,.04); animation:float 3s ease-in-out infinite; }

    .open-panel-item { cursor:pointer; transition: all .2s ease; border-radius:12px; }
    .open-panel-item:hover { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); transform: translateX(4px); }

    .sync-badge { display:inline-flex; align-items:center; gap:6px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:#fff; padding:6px 12px; border-radius:999px; font-size:11px; font-weight:800; box-shadow:0 4px 12px rgba(16,185,129,.3); animation:pulse-glow 2s infinite; }
    
    /* Top 5 Rankings Styles */
    .ranking-item { display:flex; align-items:center; gap:12px; padding:12px; background:#f8fafc; border-radius:8px; margin-bottom:8px; transition:all .2s ease; }
    .ranking-item:hover { background:#e2e8f0; transform:translateX(4px); }
    .ranking-pos { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:14px; flex-shrink:0; }
    .ranking-pos.gold { background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
    .ranking-pos.silver { background:linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
    .ranking-pos.bronze { background:linear-gradient(135deg, #fb923c 0%, #ea580c 100%); }
    .ranking-info { flex:1; }
    .ranking-name { font-weight:800; font-size:14px; color:#1e293b; }
    .ranking-details { font-size:11px; color:#64748b; margin-top:2px; }
    .ranking-value { font-weight:900; font-size:16px; color:#3b82f6; text-align:right; }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <nav class="menu">
        <div class="item active" id="nav-dash" onclick="go('dash')" title="Dashboard"><span>üìä</span></div>
        <div class="item" id="nav-data" onclick="go('data')" title="Editar Dados"><span>üìù</span></div>
        <div class="item" id="nav-juridico" onclick="go('juridico')" title="Jur√≠dico"><span>‚öñÔ∏è</span></div>
        <div class="item" id="nav-config" onclick="showConfigMenu()" title="Configura√ß√µes"><span>‚öôÔ∏è</span></div>
      </nav>

      <div class="footer">
        <div class="badge" id="badge-month">ATUAL</div>
        <div id="sync-status" style="font-size:9px; margin-top:4px; color:rgba(255,255,255,0.6);"></div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="flex items-center gap-3">
          <div class="text-lg font-extrabold text-gray-800" id="page-title">Dashboard</div>
          <div class="text-xs font-bold text-gray-500" id="page-sub">Vis√£o geral do m√™s atual</div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <div class="month-selector" style="margin:0; padding:0; box-shadow:none; background:transparent;">
            <select id="month-switch" onchange="handleMonthSwitch()"></select>
          </div>
          <button class="btn btn-primary" onclick="saveCurrentMonthWithChecks()">üíæ Salvar</button>
          <button class="btn btn-success" onclick="updateDashboard(); go('dash')">üîÑ Atualizar</button>
        </div>
      </div>

      <!-- DASHBOARD PAGE -->
      <section id="page-dash" class="page active">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="kpi-card border-blue-500" onclick="kpiFilter('all')" style="border-image:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) 1;"><p class="kpi-label">Total de Eventos</p><p class="kpi-value" style="background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-total">0</p><p class="kpi-sub">Todos registros</p></div>
          <div class="kpi-card border-purple-500" onclick="kpiFilter('roubo')" style="border-image:linear-gradient(135deg, #a855f7 0%, #9333ea 100%) 1;"><p class="kpi-label">Roubo / Furto</p><p class="kpi-value" style="background:linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-roubo">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-cyan-500" onclick="kpiFilter('vidros')" style="border-image:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) 1;"><p class="kpi-label">Vidros</p><p class="kpi-value" style="background:linear-gradient(135deg, #06b6d4 0%, #0e7490 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-vidros">0</p><p class="kpi-sub">Filtro: EVENTO TIPO</p></div>
          <div class="kpi-card border-yellow-500" onclick="kpiFilter('acordos')" style="border-image:linear-gradient(135deg, #eab308 0%, #ca8a04 100%) 1;"><p class="kpi-label">Acordos</p><p class="kpi-value" style="background:linear-gradient(135deg, #eab308 0%, #a16207 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-acordos">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-green-500" onclick="kpiFilter('finalizados')" style="border-image:linear-gradient(135deg, #22c55e 0%, #16a34a 100%) 1;"><p class="kpi-label">Finalizados</p><p class="kpi-value" style="background:linear-gradient(135deg, #22c55e 0%, #15803d 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-finalizados">0</p><p class="kpi-sub">Clique para filtrar</p></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="kpi-card border-slate-500" onclick="kpiFilter('terceiroCausador')" style="border-image:linear-gradient(135deg, #64748b 0%, #475569 100%) 1;"><p class="kpi-label">3¬∫ causador</p><p class="kpi-value" style="background:linear-gradient(135deg, #64748b 0%, #334155 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-terc-causador">0</p><p class="kpi-sub">Filtro: CAUSADOR</p></div>
          <div class="kpi-card border-indigo-500" onclick="kpiFilter('jurEm')" style="border-image:linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) 1;"><p class="kpi-label">Jur√≠dico: Em cobran√ßa</p><p class="kpi-value" style="background:linear-gradient(135deg, #6366f1 0%, #4338ca 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-jur-em">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-emerald-500" onclick="kpiFilter('jurRec')" style="border-image:linear-gradient(135deg, #10b981 0%, #059669 100%) 1;"><p class="kpi-label">Jur√≠dico: Recuperado</p><p class="kpi-value" style="background:linear-gradient(135deg, #10b981 0%, #047857 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-jur-rec">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-rose-500" onclick="kpiFilter('jurNao')" style="border-image:linear-gradient(135deg, #f43f5e 0%, #e11d48 100%) 1;"><p class="kpi-label">Jur√≠dico: N√£o cobrar</p><p class="kpi-value" style="background:linear-gradient(135deg, #f43f5e 0%, #be123c 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-jur-nao">0</p><p class="kpi-sub">Encerrar sem cobran√ßa</p></div>
          <div class="kpi-card border-amber-500" onclick="kpiFilter('jurValor')" style="border-image:linear-gradient(135deg, #f59e0b 0%, #d97706 100%) 1;"><p class="kpi-label">Valor a recuperar</p><p class="kpi-value" style="background:linear-gradient(135deg, #f59e0b 0%, #b45309 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="kpi-jur-valor">R$ 0,00</p><p class="kpi-sub">Clique para filtrar</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="chart-card"><h3 class="font-bold text-gray-700 mb-4 text-lg">üìä Eventos por Tipo</h3><canvas id="chart-tipo" style="max-height:280px;"></canvas></div>
          <div class="chart-card"><h3 class="font-bold text-gray-700 mb-4 text-lg">‚öñÔ∏è Status Jur√≠dico</h3><canvas id="chart-juridico" style="max-height:280px;"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="chart-card"><h3 class="font-bold text-gray-700 mb-4 text-lg">üí∞ Custos por Categoria</h3><canvas id="chart-custos" style="max-height:280px;"></canvas></div>
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-bold text-gray-700 text-lg">üìå Em aberto (eventos)</h3>
              <button class="btn btn-primary" onclick="kpiFilter('open')">Ver na planilha</button>
            </div>
            <div id="open-panel" class="text-sm text-gray-700"></div>
          </div>
        </div>

        <!-- TOP 5 OFICINAS E CARROS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card">
            <h3 class="font-bold text-gray-700 mb-4 text-lg">üèÜ Top 5 Oficinas (mais carros)</h3>
            <div id="top-oficinas"></div>
          </div>
          <div class="card">
            <h3 class="font-bold text-gray-700 mb-4 text-lg">üíé Top 5 Carros mais caros</h3>
            <div id="top-carros"></div>
          </div>
        </div>

        <!-- RANKING JUR√çDICO -->
        <div class="card mb-6">
          <h3 class="font-bold text-gray-700 mb-4 text-lg">‚öñÔ∏è Ranking Jur√≠dico - Maiores valores a recuperar</h3>
          <div id="ranking-juridico"></div>
        </div>
      </section>

      <!-- EDITAR DADOS PAGE -->
      <section id="page-data" class="page">
        <div class="alert alert-info" style="background:#dbeafe; border-left:4px solid #3b82f6; padding:16px; border-radius:8px; margin-bottom:16px;">
          üí° <b>EVENTO TIPO</b> (VIDROS/ROUBO etc.) define o que aparece no Dashboard. <b>CAUSADOR</b> define quem causou (TERCEIRO entra no Jur√≠dico).
        </div>
        <div class="card"><div id="spreadsheet"></div></div>
      </section>

      <!-- JUR√çDICO PAGE -->
      <section id="page-juridico" class="page">
        <div class="card mb-4">
          <h2 class="text-2xl font-extrabold text-gray-800">‚öñÔ∏è Jur√≠dico (3¬∫ causador)</h2>
          <p class="text-sm text-gray-600 mt-1">Somente eventos em que <b>CAUSADOR = TERCEIRO</b>. EVENTO TIPO pode ser VIDROS, ROUBO/FURTO etc.</p>
        </div>

        <div class="card">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
            <div class="text-sm font-bold text-gray-700">Somente registros com CAUSADOR = TERCEIRO</div>
            <button class="btn btn-primary" onclick="filterJuridicoView()">üîé Atualizar lista</button>
          </div>
          <div id="juridico-table" class="text-sm"></div>
        </div>
      </section>

      <!-- MODAIS -->
      <div id="importModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
          <div class="p-4 border-b-2 border-[#002B5C] flex justify-between items-center bg-gradient-to-r from-[#002B5C] to-[#003d7a] rounded-t-lg">
            <h3 class="font-bold text-lg text-white">üìã Importar Dados do Excel</h3>
            <button onclick="closeImportModal()" class="text-white hover:text-orange-300 font-bold text-2xl">&times;</button>
          </div>
          <div class="p-4 flex-1 overflow-y-auto">
            <div class="bg-blue-50 border-l-4 border-[#002B5C] p-3 mb-4 rounded text-xs">
              <p class="font-bold text-[#002B5C] mb-2">‚úÖ PASSO A PASSO:</p>
              <ol class="list-decimal list-inside text-gray-700 space-y-1">
                <li>No Excel, selecione <b>SEM O CABE√áALHO</b> (apenas os dados)</li>
                <li>Pressione <b>Ctrl+C</b> para copiar</li>
                <li>Cole na caixa abaixo <b>Ctrl+V</b></li>
                <li>Clique em <b>Processar Dados</b></li>
              </ol>
            </div>
            <p class="text-xs font-bold text-gray-700 mb-2">üìç ORDEM EXATA DAS COLUNAS (12):</p>
            <div class="bg-gray-100 p-3 rounded text-xs font-mono text-gray-800 mb-4 overflow-x-auto">
              1.Assoc | 2.Benefici√°rio | 3.Ve√≠culo | 4.Placa | 5.Data | 6.Oficina | 7.Cota | 8.MO | 9.Pe√ßas | 10.Outras | 11.TOTAL | 12.Situa√ß√£o
            </div>
            <textarea id="pasteArea" class="w-full border-2 border-[#002B5C] rounded p-3 text-xs font-mono h-48 resize-none" placeholder="Cole seus dados aqui (Ctrl+V)..."></textarea>
          </div>
          <div class="p-4 border-t-2 border-[#002B5C] bg-gray-50 rounded-b-lg text-right">
            <button onclick="processPaste()" class="bg-[#FF6B35] hover:bg-[#e55a24] text-white px-6 py-2 rounded font-bold text-sm">‚úîÔ∏è Processar Dados</button>
          </div>
        </div>
      </div>

      <div id="configModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="p-6 border-b bg-gradient-to-r from-blue-500 to-purple-600 rounded-t-2xl">
            <h3 class="font-bold text-xl text-white flex items-center gap-2">‚öôÔ∏è Menu de Configura√ß√µes</h3>
          </div>
          <div class="p-6">
            <div class="space-y-3">
              <button onclick="openImportModal(); closeConfigModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üìã</span> Colar dados do Excel
              </button>
              <button onclick="exportData(); closeConfigModal()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üíæ</span> Exportar CSV
              </button>
              <button onclick="exportAllBackup(); closeConfigModal()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üóÑÔ∏è</span> Gerar backup completo
              </button>
              <button onclick="importBackupFile(); closeConfigModal()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üìÇ</span> Restaurar backup
              </button>
              <hr class="border-gray-300">
              <div class="text-xs text-gray-600 font-bold uppercase tracking-wide px-2">‚òÅÔ∏è Sincroniza√ß√£o Nuvem</div>
              <button onclick="downloadFromFirebase(); closeConfigModal()" class="w-full bg-sky-500 hover:bg-sky-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üì•</span> Baixar da nuvem
              </button>
              <button onclick="uploadToFirebase(); closeConfigModal()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg font-bold text-left flex items-center gap-3">
                <span>üì§</span> Enviar para nuvem
              </button>
            </div>
          </div>
          <div class="p-4 bg-gray-50 rounded-b-2xl text-right">
            <button onclick="closeConfigModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-bold">Fechar</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    const JURIDICO_STATUS = ['N√ÉO INICIADO','EM COBRAN√áA','COBRADO','ACORDO','N√ÉO COBRAR','RECUPERADO'];
    const CAUSADOR_OPTS = ['ASSOCIADO','TERCEIRO','N√ÉO IDENTIFICADO'];
    const EVENTO_TIPO_OPTS = ['VIDROS','ROUBO/FURTO','COLIS√ÉO','OUTROS'];

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let chartTipo, chartJuridico, chartCustos;
    let firebaseDb = null;

    // ============ FIREBASE AUTO-CONNECT ============
    function initFirebase() {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyASDJpwHTtOn71liMYaMTwyWVDY4s1FJRU",
          authDomain: "porto-mais-eventos.firebaseapp.com",
          databaseURL: "https://porto-mais-eventos-default-rtdb.firebaseio.com",
          projectId: "porto-mais-eventos",
          storageBucket: "porto-mais-eventos.firebasestorage.app",
          messagingSenderId: "1084717178712",
          appId: "1:1084717178712:web:05f7aa39e06d626d208f2d"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        firebaseDb = firebase.database();
        
        document.getElementById('sync-status').innerHTML = '<span style="color:#10b981;">‚úì Online</span>';
        console.log('‚úÖ Firebase conectado automaticamente!');
        
        // Auto-sync a cada 30 segundos (apenas upload)
        setInterval(() => {
          if (firebaseDb) {
            const md = saveCurrentMonth();
            firebaseDb.ref('months/' + monthKey(currentYear, currentMonth)).set(md)
              .then(() => console.log('üîÑ Auto-sync realizado'))
              .catch(err => console.error('Erro no auto-sync:', err));
          }
        }, 30000);
        
      } catch (error) {
        console.warn('Firebase n√£o configurado:', error);
        document.getElementById('sync-status').innerHTML = '<span style="color:#64748b;">Offline</span>';
      }
    }

    // ============ DOWNLOAD DA NUVEM (NOVO) ============
    async function downloadFromFirebase() {
      if (!firebaseDb) {
        Swal.fire('Firebase n√£o dispon√≠vel', 'Conex√£o com nuvem n√£o configurada.', 'warning');
        return;
      }

      Swal.fire({
        title: 'üì• Baixando da nuvem...',
        html: 'Aguarde enquanto buscamos seus dados do Firebase.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try {
        const snapshot = await firebaseDb.ref('months').once('value');
        const cloudData = snapshot.val();

        if (!cloudData || Object.keys(cloudData).length === 0) {
          Swal.fire('‚ö†Ô∏è Nuvem vazia', 'N√£o h√° dados salvos na nuvem ainda. Use "Enviar para nuvem" primeiro.', 'info');
          return;
        }

        // Mesclar dados da nuvem com dados locais
        let downloadedCount = 0;
        let updatedCount = 0;
        let skippedCount = 0;

        for (const [key, cloudMonth] of Object.entries(cloudData)) {
          const localData = localStorage.getItem(key);
          
          if (!localData) {
            // N√£o existe local - baixar
            localStorage.setItem(key, JSON.stringify(cloudMonth));
            downloadedCount++;
          } else {
            // Existe local - comparar datas
            const localMonth = JSON.parse(localData);
            const cloudDate = new Date(cloudMonth.saveDate || 0);
            const localDate = new Date(localMonth.saveDate || 0);
            
            if (cloudDate > localDate) {
              // Nuvem √© mais recente - atualizar
              localStorage.setItem(key, JSON.stringify(cloudMonth));
              updatedCount++;
            } else {
              // Local √© mais recente ou igual - manter
              skippedCount++;
            }
          }
        }

        // Recarregar interface
        fillMonthSwitch();
        
        // Carregar o m√™s mais recente
        const months = getSavedMonths();
        if (months.length > 0) {
          const latest = months[0];
          currentYear = latest.year;
          currentMonth = latest.month;
          hot.loadData(latest.data || []);
          setBadge();
          updateDashboard();
        }

        const html = `
          <div class="text-left text-sm">
            <p class="mb-2"><b>‚úÖ Sincroniza√ß√£o conclu√≠da!</b></p>
            <ul class="space-y-1">
              <li>üÜï <b>${downloadedCount}</b> m√™s(es) baixado(s)</li>
              <li>üîÑ <b>${updatedCount}</b> m√™s(es) atualizado(s)</li>
              <li>‚úÖ <b>${skippedCount}</b> m√™s(es) j√° atualizado(s)</li>
            </ul>
          </div>
        `;

        Swal.fire({
          icon: 'success',
          title: 'Dados sincronizados!',
          html: html,
          confirmButtonText: 'OK'
        });

      } catch (error) {
        console.error('Erro ao baixar da nuvem:', error);
        Swal.fire('Erro', 'Falha ao baixar dados: ' + error.message, 'error');
      }
    }

    // ============ UPLOAD PARA NUVEM (RENOMEADO) ============
    function uploadToFirebase() {
      if (!firebaseDb) {
        Swal.fire('Firebase n√£o dispon√≠vel', 'Conex√£o com nuvem n√£o configurada.', 'warning');
        return;
      }
      
      const months = getSavedMonths();
      if (months.length === 0) {
        Swal.fire('‚ö†Ô∏è Nenhum dado local', 'Adicione alguns eventos antes de enviar para a nuvem.', 'info');
        return;
      }

      Swal.fire({
        title: 'üì§ Enviando para nuvem...',
        html: `Fazendo upload de ${months.length} m√™s(es)...`,
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });
      
      const promises = months.map(m => 
        firebaseDb.ref('months/' + m.key).set({
          year: m.year,
          month: m.month,
          monthLabel: m.monthLabel,
          saveDate: new Date().toLocaleString('pt-BR'),
          data: m.data
        })
      );
      
      Promise.all(promises)
        .then(() => Swal.fire('‚úÖ Enviado!', `${months.length} m√™s(es) salvos na nuvem com sucesso.`, 'success'))
        .catch(err => Swal.fire('Erro', 'Falha ao enviar: ' + err.message, 'error'));
    }

    // Alias para compatibilidade
    function syncToFirebase() {
      uploadToFirebase();
    }

    // ============ PARSE DE DATAS DD/MM/YYYY (FIX JANEIRO) ============
    function parseDateDDMMYYYY(dateStr) {
      if (!dateStr) return null;
      
      const str = dateStr.toString().trim();
      
      // Formato DD/MM/YYYY
      const match = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if (match) {
        const day = parseInt(match[1]);
        const month = parseInt(match[2]) - 1; // JS months s√£o 0-indexed
        const year = parseInt(match[3]);
        
        // FIX: Validar se m√™s √© v√°lido (0-11)
        if (month >= 0 && month <= 11) {
          return new Date(year, month, day);
        }
      }
      
      return null;
    }

    // ============ NAVIGATION ============
    function go(page){
      const pages = ['data','dash','juridico'];
      pages.forEach(p=>{
        const el = document.getElementById('page-'+p);
        const nav = document.getElementById('nav-'+p);
        if(el) el.classList.toggle('active', p===page);
        if(nav) nav.classList.toggle('active', p===page);
      });
      const titleMap = { data:'Editar dados', dash:'Dashboard', juridico:'Jur√≠dico (3¬∫ causador)' };
      const subMap = { data:'Tabela principal do m√™s selecionado', dash:'KPIs, gr√°ficos e rankings do m√™s', juridico:'Cobran√ßa e status jur√≠dico (3¬∫ causador)' };
      document.getElementById('page-title').innerText = titleMap[page] || 'Gerenciador';
      document.getElementById('page-sub').innerText = subMap[page] || '';
      if(page==='dash') updateDashboard();
      if(page==='juridico') filterJuridicoView();
      if(page==='data') setTimeout(()=>hot.render(), 50);
    }

    function showConfigMenu() {
      document.getElementById('configModal').classList.remove('hidden');
    }
    
    function closeConfigModal() {
      document.getElementById('configModal').classList.add('hidden');
    }

    function monthKey(y, m){ return `month_${y}_${String(m).padStart(2,'0')}`; }
    function monthLabel(y,m){ const d = new Date(y, m-1); return d.toLocaleString('pt-BR',{month:'long',year:'numeric'}).toUpperCase(); }
    function setBadge(){ const b = document.getElementById('badge-month'); if(b) b.innerText = monthLabel(currentYear, currentMonth); }

    function getSavedMonths(){
      const months = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('month_')){ try{ months.push({ key:k, ...JSON.parse(localStorage.getItem(k)) }); }catch(e){} }
      }
      return months.sort((a,b)=> (b.year-a.year) || (b.month-a.month));
    }

    function fillMonthSwitch(){
      const sel = document.getElementById('month-switch');
      const months = getSavedMonths();
      const keyNow = monthKey(currentYear, currentMonth);
      const existsNow = months.some(m=>m.key===keyNow);
      const list = existsNow ? months : [{key:keyNow, year:currentYear, month:currentMonth, monthLabel:monthLabel(currentYear,currentMonth), data: hot ? hot.getData(): []}, ...months];
      sel.innerHTML = list.map(m=>`<option value="${m.key}">${m.monthLabel || monthLabel(m.year,m.month)}</option>`).join('');
      sel.value = keyNow;
    }

    function handleMonthSwitch(){
      const key = document.getElementById('month-switch').value;
      const md = JSON.parse(localStorage.getItem(key) || 'null');
      if(md && md.data){ currentYear = md.year; currentMonth = md.month; hot.loadData(md.data); setBadge(); updateDashboard(); }
    }

    function saveCurrentMonth(){
      const data = hot.getData();
      const k = monthKey(currentYear, currentMonth);
      const md = { year: currentYear, month: currentMonth, monthLabel: monthLabel(currentYear,currentMonth), saveDate: new Date().toLocaleString('pt-BR'), data };
      localStorage.setItem(k, JSON.stringify(md));
      return md;
    }

    function normalizePlaca(v){ return (v||'').toString().toUpperCase().replace(/[^A-Z0-9]/g,'').trim(); }
    function isOpenStatus(status){ const s = (status||'').toString().toUpperCase().trim(); return !(s==='FINALIZADO' || s==='NEGADO'); }

    function isVidroRow(r){ return (r[2]||'').toString().toUpperCase().trim()==='VIDROS'; }
    function isRouboRow(r){ return (r[2]||'').toString().toUpperCase().trim()==='ROUBO/FURTO'; }
    function isAcordoRow(r){ return (r[12]||'').toString().toUpperCase().trim()==='ACORDO'; }
    function isFinalizadoRow(r){ return (r[12]||'').toString().toUpperCase().trim()==='FINALIZADO'; }

    function isTerceiroCausadorRow(r){ return (r[13]||'').toString().toUpperCase().trim()==='TERCEIRO'; }
    function isJuridicoStatus(r, statuses){ return statuses.includes((r[14]||'').toString().toUpperCase().trim()); }

    function applyFilter(predicate){
      const data = hot.getData() || [];
      const matches = [];
      for(let i=0;i<data.length;i++){
        const r = data[i];
        if(!r[0]) continue;
        if(predicate(r, i)) matches.push(i);
      }
      if(!matches.length){ Swal.fire('Sem resultados','Nenhuma linha encontrada para esse filtro.','info'); return; }
      go('data');
      setTimeout(()=>{
        const filters = hot.getPlugin('filters');
        try{ filters.clearConditions(); filters.filter(); }catch(e){}
        hot.render();
        hot.selectCell(matches[0], 0);
        hot.scrollViewportTo(matches[0], 0);
        Swal.fire({ toast:true, position:'top-end', timer:1800, showConfirmButton:false, icon:'success', title:`Filtro aplicado: ${matches.length} linha(s)` });
      }, 120);
    }

    function kpiFilter(key){
      if(key==='all') return applyFilter(()=>true);
      if(key==='vidros') return applyFilter(r=>isVidroRow(r));
      if(key==='roubo') return applyFilter(r=>isRouboRow(r));
      if(key==='acordos') return applyFilter(r=>isAcordoRow(r));
      if(key==='finalizados') return applyFilter(r=>isFinalizadoRow(r));
      if(key==='open') return applyFilter(r=>isOpenStatus(r[12]));
      if(key==='terceiroCausador') return applyFilter(r=>isTerceiroCausadorRow(r));
      if(key==='jurEm') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['EM COBRAN√áA','COBRADO']));
      if(key==='jurRec') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['RECUPERADO']));
      if(key==='jurNao') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['N√ÉO COBRAR']));
      if(key==='jurValor') return applyFilter(r=>isTerceiroCausadorRow(r) && ((parseFloat(r[16])||0)>0));
    }

    function buildOpenPanel(openRows){
      const wrap = document.getElementById('open-panel');
      if(!wrap) return;
      if(!openRows.length){ wrap.innerHTML = '<div class="text-gray-400">Sem eventos em aberto neste m√™s.</div>'; return; }
      wrap.innerHTML = `
        <div class="space-y-2">
          ${openRows.slice(0,12).map(item=>{
            const v = item.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            return `
              <div class="open-panel-item border rounded-lg p-3 bg-white shadow-sm" onclick="openRow(${item.rowIndex})">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold text-gray-800">${item.placa || '-'} <span class="text-xs text-gray-400 font-normal">(${item.status || '-'})</span></div>
                  <div class="text-sm font-bold text-blue-600">${v}</div>
                </div>
                <div class="text-xs text-gray-500 mt-1">${item.eventoTipo || ''} ‚Ä¢ ${item.veiculo || ''} ‚Ä¢ ${item.oficina || ''}</div>
              </div>`;
          }).join('')}
          ${openRows.length>12 ? `<div class="text-xs text-gray-400 text-center mt-3">Mostrando 12 de ${openRows.length}. Use "Ver na planilha" para ver todos.</div>` : ''}
        </div>`;
    }

    // ============ TOP 5 OFICINAS (MAIS CARROS) ============
    function buildTopOficinas(data) {
      const wrap = document.getElementById('top-oficinas');
      if (!wrap) return;
      
      const oficinas = {};
      data.forEach(r => {
        if (!r[0]) return;
        const oficina = (r[6] || 'SEM OFICINA').toString().trim().toUpperCase();
        if (!oficinas[oficina]) oficinas[oficina] = { count: 0, valor: 0 };
        oficinas[oficina].count++;
        oficinas[oficina].valor += parseFloat(r[11]) || 0;
      });
      
      const sorted = Object.entries(oficinas)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);
      
      if (sorted.length === 0) {
        wrap.innerHTML = '<div class="text-gray-400 text-center py-4">Sem dados de oficinas</div>';
        return;
      }
      
      wrap.innerHTML = sorted.map(([nome, info], idx) => {
        const posClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
        return `
          <div class="ranking-item">
            <div class="ranking-pos ${posClass}">${idx + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${nome}</div>
              <div class="ranking-details">${info.valor.toLocaleString('pt-BR', {style:'currency',currency:'BRL'})}</div>
            </div>
            <div class="ranking-value">${info.count} carros</div>
          </div>
        `;
      }).join('');
    }

    // ============ TOP 5 CARROS MAIS CAROS ============
    function buildTopCarros(data) {
      const wrap = document.getElementById('top-carros');
      if (!wrap) return;
      
      const carros = data
        .filter(r => r[0] && r[4]) // Tem associa√ß√£o e placa
        .map((r, idx) => ({
          placa: normalizePlaca(r[4]),
          veiculo: r[3] || 'N/D',
          valor: parseFloat(r[11]) || 0,
          rowIndex: idx
        }))
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 5);
      
      if (carros.length === 0) {
        wrap.innerHTML = '<div class="text-gray-400 text-center py-4">Sem dados de ve√≠culos</div>';
        return;
      }
      
      wrap.innerHTML = carros.map((car, idx) => {
        const posClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
        return `
          <div class="ranking-item" onclick="openRow(${car.rowIndex})">
            <div class="ranking-pos ${posClass}">${idx + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${car.placa}</div>
              <div class="ranking-details">${car.veiculo}</div>
            </div>
            <div class="ranking-value">${car.valor.toLocaleString('pt-BR', {style:'currency',currency:'BRL'})}</div>
          </div>
        `;
      }).join('');
    }

    // ============ RANKING JUR√çDICO (VALOR A RECUPERAR) ============
    function buildRankingJuridico(data) {
      const wrap = document.getElementById('ranking-juridico');
      if (!wrap) return;
      
      const juridico = data
        .map((r, idx) => ({ r, idx }))
        .filter(x => isTerceiroCausadorRow(x.r) && (parseFloat(x.r[16]) || 0) > 0)
        .map(x => ({
          placa: normalizePlaca(x.r[4]),
          veiculo: x.r[3] || 'N/D',
          beneficiario: x.r[1] || 'N/D',
          eventoTipo: x.r[2] || 'N/D',
          status: x.r[14] || 'N/D',
          valorRecuperar: parseFloat(x.r[16]) || 0,
          rowIndex: x.idx
        }))
        .sort((a, b) => b.valorRecuperar - a.valorRecuperar)
        .slice(0, 10);
      
      if (juridico.length === 0) {
        wrap.innerHTML = '<div class="text-gray-400 text-center py-4">Sem valores a recuperar no momento</div>';
        return;
      }
      
      wrap.innerHTML = juridico.map((item, idx) => {
        const posClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
        return `
          <div class="ranking-item" onclick="openRow(${item.rowIndex})">
            <div class="ranking-pos ${posClass}">${idx + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${item.placa} - ${item.beneficiario}</div>
              <div class="ranking-details">${item.eventoTipo} ‚Ä¢ Status: ${item.status} ‚Ä¢ ${item.veiculo}</div>
            </div>
            <div class="ranking-value">${item.valorRecuperar.toLocaleString('pt-BR', {style:'currency',currency:'BRL'})}</div>
          </div>
        `;
      }).join('');
    }

    function openRow(rowIndex){ go('data'); setTimeout(()=>{ hot.selectCell(rowIndex, 0); hot.scrollViewportTo(rowIndex, 0); }, 120); }

    function findOpenPlateInOtherMonths(placa){
      const p = normalizePlaca(placa);
      if(!p) return null;
      const months = getSavedMonths();
      for(const m of months){
        if(m.year===currentYear && m.month===currentMonth) continue;
        const rows = m.data || [];
        for(const r of rows){
          const placaR = normalizePlaca(r[4]);
          const st = r[12];
          if(placaR===p && isOpenStatus(st)) return { monthLabel: m.monthLabel || monthLabel(m.year,m.month), key: m.key, status: st };
        }
      }
      return null;
    }

    async function saveCurrentMonthWithChecks(){
      const rows = hot.getData();
      const duplicates = [];
      for(const r of rows){ if(!r[0]) continue; const found = findOpenPlateInOtherMonths(r[4]); if(found) duplicates.push({ placa: normalizePlaca(r[4]), found }); }
      if(duplicates.length){
        const first = duplicates[0];
        const html = `<div class="text-left text-sm">
          <p><b>Encontramos placa(s) j√° em aberto em outro m√™s.</b></p>
          <p class="mt-2">Exemplo: <b>${first.placa}</b> est√° em <b>${first.found.monthLabel}</b> (status: ${first.found.status||'-'}).</p>
          <p class="mt-2 text-xs text-gray-500">O sistema n√£o vai duplicar para outro m√™s. V√° no m√™s onde est√° aberto e finalize/negue antes.</p>
        </div>`;
        const res = await Swal.fire({ title: '‚ö†Ô∏è Placa j√° em aberto', html, icon: 'warning', showCancelButton: true, confirmButtonText: 'Ir para o m√™s', cancelButtonText: 'Cancelar' });
        if(res.isConfirmed){
          const md = JSON.parse(localStorage.getItem(first.found.key));
          if(md){ currentYear = md.year; currentMonth = md.month; hot.loadData(md.data); fillMonthSwitch(); setBadge(); go('data'); }
        }
        return;
      }
      saveCurrentMonth(); fillMonthSwitch(); setBadge(); 
      
      // Auto-sync com Firebase se dispon√≠vel
      if (firebaseDb) {
        const md = saveCurrentMonth();
        firebaseDb.ref('months/' + monthKey(currentYear, currentMonth)).set(md)
          .then(() => Swal.fire('‚úÖ Salvo!', 'M√™s salvo e sincronizado com a nuvem.', 'success'))
          .catch(() => Swal.fire('‚úÖ Salvo!', 'M√™s salvo localmente.', 'success'));
      } else {
        Swal.fire('‚úÖ Salvo!', 'M√™s salvo com sucesso.', 'success');
      }
    }

    function exportAllBackup(){
      const months = getSavedMonths();
      if(!months.length){ Swal.fire('‚ùå Nenhum Backup','Nenhum m√™s salvo ainda.','error'); return; }
      const backup = { exportDate: new Date().toLocaleString('pt-BR'), totalMonths: months.length, months: months.map(m=>({monthLabel:m.monthLabel, year:m.year, month:m.month, saveDate:m.saveDate, data:m.data})) };
      const blob = new Blob([JSON.stringify(backup,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_portoMais_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importBackupFile(){
      const i = document.createElement('input');
      i.type='file'; i.accept='.json';
      i.onchange=(e)=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=(ev)=>{
          try{
            const d=JSON.parse(ev.target.result);
            if(!d.months) throw new Error('Inv√°lido');
            d.months.forEach(m=> localStorage.setItem(monthKey(m.year, m.month), JSON.stringify(m)));
            const first=d.months[0];
            currentYear=first.year; currentMonth=first.month;
            hot.loadData(first.data);
            fillMonthSwitch(); setBadge(); updateDashboard();
            Swal.fire('‚úÖ Carregado!','Backup restaurado.','success');
          }catch(err){ Swal.fire('Erro','Falha ao importar: '+err.message,'error'); }
        };
        r.readAsText(f);
      };
      i.click();
    }

    const initialData = [["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""]];

    const container = document.getElementById('spreadsheet');
    const hot = new Handsontable(container, {
      data: initialData,
      colHeaders: [
        'ASSOCIA√á√ÉO','BENEFICI√ÅRIO','EVENTO TIPO','VE√çCULO','PLACA','DATA OFICINA','OFICINA',
        'COTA','M√ÉO DE OBRA','PE√áAS','OUTRAS DESPESAS','GASTOS TOTAIS','SITUA√á√ÉO',
        'CAUSADOR','JUR√çDICO STATUS','DT ENVIO JUR√çDICO','VALOR A RECUPERAR','OBS JUR√çDICO'
      ],
      columns: [
        { type:'text' },
        { type:'dropdown', source:['ASSOCIADO','TERCEIRO'] },
        { type:'dropdown', source: EVENTO_TIPO_OPTS },
        { type:'text' },
        { type:'text' },
        { type:'date', dateFormat:'DD/MM/YYYY', correctFormat:true },
        { type:'text' },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' }, readOnly:true },
        { type:'dropdown', source:['FINALIZADO','EM ANDAMENTO','NEGADO','PENDENTE','ACORDO'] },
        { type:'dropdown', source: CAUSADOR_OPTS },
        { type:'dropdown', source: JURIDICO_STATUS },
        { type:'date', dateFormat:'DD/MM/YYYY', correctFormat:true },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'text' }
      ],
      rowHeaders: true,
      width:'100%',
      height:'65vh',
      licenseKey:'non-commercial-and-evaluation',
      minSpareRows: 1,
      filters:true,
      dropdownMenu:true,
      manualColumnResize:true,
      autoWrapRow:true,
      stretchH:'all',
      afterChange(changes, source){
        if(!changes || source==='source') return;
        changes.forEach(([row, col])=>{
          if([7,8,9,10].includes(col)){
            const cota=parseFloat(this.getDataAtCell(row,7))||0;
            const mao=parseFloat(this.getDataAtCell(row,8))||0;
            const pecas=parseFloat(this.getDataAtCell(row,9))||0;
            const outras=parseFloat(this.getDataAtCell(row,10))||0;
            this.setDataAtCell(row,11, cota+mao+pecas+outras, 'source');
          }
        });
        saveCurrentMonth(); fillMonthSwitch(); setBadge();
      }
    });

    function openImportModal(){ document.getElementById('importModal').classList.remove('hidden'); }
    function closeImportModal(){ document.getElementById('importModal').classList.add('hidden'); }

    function inferEventoTipoFromRow12(base12){
      const veic = (base12[2]||'').toString().toUpperCase();
      const ofi = (base12[5]||'').toString().toUpperCase();
      const sit = (base12[11]||'').toString().toUpperCase();
      if(veic.includes('ROUBO') || veic.includes('FURTO') || ofi.includes('INDENIZA') || sit.includes('INDENIZA')) return 'ROUBO/FURTO';
      if(veic.includes('VIDRO') || ofi.includes('VIDRO') || ofi.includes('CARGLASS') || ofi.includes('AUTO GLASS') || sit.includes('VIDRO')) return 'VIDROS';
      return 'OUTROS';
    }

    function processPaste(){
      const raw = (document.getElementById('pasteArea').value||'').trim();
      if(!raw){ Swal.fire('‚ö†Ô∏è Aten√ß√£o','Cole os dados primeiro.','warning'); return; }

      const rows = raw.split('\n').map(line=>{
        let parts = line.split('\t');
        if(parts.length===1) parts=line.split(',');
        if(parts.length===1) parts=line.split(/\s{2,}/);
        return parts.map(p=>p.trim());
      });

      const normalized = rows.map(r=>{
        const base = r.slice(0,12);
        while(base.length<12) base.push('');
        const eventoTipo = inferEventoTipoFromRow12(base);
        const row18 = [base[0], base[1], eventoTipo, base[2], base[3], base[4], base[5], base[6], base[7], base[8], base[9], base[10], base[11], 'N√ÉO IDENTIFICADO','N√ÉO INICIADO','','',''];
        return row18;
      });

      const kept=[];
      const blocked=[];
      for(const r of normalized){
        const found = findOpenPlateInOtherMonths(r[4]);
        if(found) blocked.push({placa: normalizePlaca(r[4]), month: found.monthLabel});
        else kept.push(r);
      }

      hot.populateFromArray(0,0, kept);
      closeImportModal();
      document.getElementById('pasteArea').value='';
      saveCurrentMonth(); fillMonthSwitch(); setBadge();

      if(blocked.length) Swal.fire('‚ö†Ô∏è Alguns registros foram bloqueados', `${blocked.length} placa(s) j√° estavam em aberto em outro m√™s e n√£o foram importadas.`, 'warning');
      else Swal.fire('‚úÖ Sucesso!', `${kept.length} linhas importadas com sucesso!`, 'success');
    }

    function exportData(){ const exportPlugin = hot.getPlugin('exportFile'); exportPlugin.downloadFile('csv', { filename:'Eventos_PortoMais', columnHeaders:true, bom:true }); }

    function updateDashboard(){
      let data=[]; try{ data = hot.getData(); }catch(e){}

      let tEv=0, cVid=0, cRou=0, cCol=0, cOut=0, cAcor=0, cFin=0;
      let $Vid=0, $Rou=0, $Col=0, $Out=0;
      let jurEm=0, jurRec=0, jurNao=0, jurValor=0, tercCaus=0;
      let jurStatusCounts = {};
      let openRows=[];

      if(data && data.length){
        data.forEach((r, idx)=>{
          if(!r[0]) return;
          tEv++;

          const val = (parseFloat(r[8])||0) + (parseFloat(r[9])||0) + (parseFloat(r[10])||0);
          const tipo = (r[2]||'').toString().toUpperCase().trim();

          if(tipo==='ROUBO/FURTO'){ cRou++; $Rou+=val; }
          else if(tipo==='VIDROS'){ cVid++; $Vid+=val; }
          else if(tipo==='COLIS√ÉO'){ cCol++; $Col+=val; }
          else { cOut++; $Out+=val; }

          if(isAcordoRow(r)) cAcor++;
          if(isFinalizadoRow(r)) cFin++;

          if(isOpenStatus(r[12])){
            openRows.push({ rowIndex: idx, placa: normalizePlaca(r[4]), veiculo: r[3]||'', oficina: r[6]||'', status: r[12]||'', valor: (parseFloat(r[11])||0), eventoTipo: r[2]||'' });
          }

          if(isTerceiroCausadorRow(r)){
            const jur = (r[14]||'').toString().toUpperCase().trim();
            const valRec = parseFloat(r[16]) || 0;
            tercCaus++;
            if(jur) jurStatusCounts[jur] = (jurStatusCounts[jur]||0)+1;
            if(jur==='EM COBRAN√áA' || jur==='COBRADO') jurEm++;
            if(jur==='RECUPERADO') jurRec++;
            if(jur==='N√ÉO COBRAR') jurNao++;
            jurValor += valRec;
          }
        });
      }

      const el=(i,v)=>{ const e=document.getElementById(i); if(e) e.innerText=v; };
      const m=(v)=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

      el('kpi-total', tEv);
      el('kpi-roubo', cRou);
      el('kpi-vidros', cVid);
      el('kpi-acordos', cAcor);
      el('kpi-finalizados', cFin);
      el('kpi-terc-causador', tercCaus);
      el('kpi-jur-em', jurEm);
      el('kpi-jur-rec', jurRec);
      el('kpi-jur-nao', jurNao);
      el('kpi-jur-valor', m(jurValor));

      buildOpenPanel(openRows.sort((a,b)=> (b.valor-a.valor)));
      buildTopOficinas(data);
      buildTopCarros(data);
      buildRankingJuridico(data);

      if(chartTipo) chartTipo.destroy();
      chartTipo = new Chart(document.getElementById('chart-tipo'), {
        type:'doughnut',
        data:{
          labels:['Vidros','Roubo/Furto','Colis√£o','Outros'],
          datasets:[{
            data:[cVid, cRou, cCol, cOut],
            backgroundColor:['#06b6d4','#a855f7','#f59e0b','#64748b'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{position:'bottom', labels:{font:{size:11,weight:'bold'}, padding:12}},
            tooltip:{backgroundColor:'rgba(0,0,0,0.8)', padding:12, bodyFont:{size:13}}
          },
          animation:{animateRotate:true, animateScale:true, duration:800}
        }
      });

      if(chartJuridico) chartJuridico.destroy();
      const jLabs = Object.keys(jurStatusCounts);
      const jVals = Object.values(jurStatusCounts);
      chartJuridico = new Chart(document.getElementById('chart-juridico'), {
        type:'pie',
        data:{
          labels: jLabs.length? jLabs : ['Sem dados'],
          datasets:[{
            data: jLabs.length? jVals : [1],
            backgroundColor:['#6366f1','#10b981','#f43f5e','#eab308','#64748b','#06b6d4'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{position:'bottom', labels:{font:{size:11,weight:'bold'}, padding:12}},
            tooltip:{backgroundColor:'rgba(0,0,0,0.8)', padding:12, bodyFont:{size:13}}
          },
          animation:{animateRotate:true, animateScale:true, duration:800}
        }
      });

      if(chartCustos) chartCustos.destroy();
      chartCustos = new Chart(document.getElementById('chart-custos'), {
        type:'bar',
        data:{
          labels:['Vidros','Roubo/Furto','Colis√£o','Outros'],
          datasets:[{
            label:'Custo Total (R$)',
            data:[$Vid, $Rou, $Col, $Out],
            backgroundColor:['#06b6d4','#a855f7','#f59e0b','#64748b'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{backgroundColor:'rgba(0,0,0,0.8)', padding:12, bodyFont:{size:13}, callbacks:{label:ctx=> 'R$ '+ctx.parsed.y.toLocaleString('pt-BR',{minimumFractionDigits:2})}}
          },
          scales:{
            y:{beginAtZero:true, ticks:{callback:v=>'R$ '+v.toLocaleString('pt-BR'), font:{size:10}}}
          },
          animation:{duration:800, easing:'easeInOutQuart'}
        }
      });
    }

    function filterJuridicoView(){
      const data = hot.getData() || [];
      const rows = data.map((r, idx)=>({r, idx})).filter(x=> isTerceiroCausadorRow(x.r));
      const wrap = document.getElementById('juridico-table');
      if(!wrap) return;
      if(!rows.length){ wrap.innerHTML = '<div class="text-gray-400">Sem eventos com CAUSADOR = TERCEIRO neste m√™s.</div>'; return; }
      const head = ['PLACA','EVENTO TIPO','BENEFICI√ÅRIO','VE√çCULO','SITUA√á√ÉO','STATUS JUR√çDICO','VALOR RECUP.','OBS'];
      wrap.innerHTML = `
        <div class="overflow-auto">
          <table class="min-w-full text-xs">
            <thead><tr>${head.map(h=>`<th class="text-left p-2 bg-gray-100 border">${h}</th>`).join('')}</tr></thead>
            <tbody>
              ${rows.map(x=>{
                const r = x.r;
                const placa = normalizePlaca(r[4]);
                const valRec = parseFloat(r[16])||0;
                return `<tr class="border-b hover:bg-gray-50 open-panel-item" onclick="openRow(${x.idx})">
                  <td class="p-2 font-extrabold">${placa||''}</td>
                  <td class="p-2 font-bold">${(r[2]||'')}</td>
                  <td class="p-2">${(r[1]||'')}</td>
                  <td class="p-2">${(r[3]||'')}</td>
                  <td class="p-2">${(r[12]||'')}</td>
                  <td class="p-2 font-bold">${(r[14]||'')}</td>
                  <td class="p-2">${valRec? valRec.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : ''}</td>
                  <td class="p-2">${(r[17]||'')}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
    }

    // Initialize
    setTimeout(()=>{ 
      initFirebase();
      setBadge(); 
      saveCurrentMonth(); 
      fillMonthSwitch(); 
      updateDashboard(); 
    }, 200);
  </script>
</body>
</html>