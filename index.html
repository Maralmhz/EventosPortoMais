<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciador de Eventos - Porto Mais</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet" />
  <link href="assets/styles.css" rel="stylesheet" />

  <style>
    .layout { display: flex; height: 100vh; overflow: hidden; }

    .sidebar { width: 270px; background: linear-gradient(180deg, #002B5C 0%, #001b3a 100%); color: #fff; flex-shrink: 0; display: flex; flex-direction: column; position: relative; transition: width .28s cubic-bezier(.2,.9,.2,1); }
    .sidebar.collapsed { width: 74px; }
    .sidebar .logo { display:flex; align-items:center; gap:12px; padding:18px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .sidebar .logo img { height: 40px; transition: transform .28s cubic-bezier(.2,.9,.2,1); }
    .sidebar.collapsed .logo img { transform: scale(.95); }
    .sidebar .logo h1 { font-size: 16px; font-weight: 800; line-height: 1.1; }
    .sidebar.collapsed .logo h1, .sidebar.collapsed .logo .text-xs { display:none; }

    .sidebar .menu { padding: 10px; display:flex; flex-direction:column; gap:6px; overflow:auto; }
    .sidebar .item { display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 12px; cursor:pointer; font-weight:800; color: rgba(255,255,255,.88); transition: transform .18s ease, background .18s ease, box-shadow .18s ease; }
    .sidebar .item:hover { background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .sidebar .item:active { transform: translateY(0px) scale(.99); }
    .sidebar .item.active { background: rgba(255,255,255,.16); color:#fff; }
    .sidebar .item .txt { white-space: nowrap; }
    .sidebar.collapsed .item { justify-content:center; }
    .sidebar.collapsed .item .txt { display:none; }

    .sidebar .footer { margin-top:auto; padding: 12px 12px 16px; border-top: 1px solid rgba(255,255,255,.08); display:flex; flex-direction:column; gap:8px; }
    .sidebar.collapsed .footer { display:none; }

    .sidebar-toggle { position:absolute; right:-14px; top:16px; width:28px; height:28px; border-radius:999px; background:#111827; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; border: 2px solid rgba(255,255,255,.15); box-shadow: 0 10px 20px rgba(0,0,0,.18); transition: transform .2s ease; }
    .sidebar-toggle:hover { transform: scale(1.06); }

    .content { flex:1; background:#f3f4f6; overflow:auto; }

    .topbar { position: sticky; top:0; z-index: 50; background: rgba(243,244,246,.92); backdrop-filter: blur(10px); border-bottom: 1px solid #e5e7eb; padding: 12px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .badge { font-size: 12px; font-weight: 800; padding: 6px 10px; border-radius: 999px; background:#111827; color:#fff; }

    .page { display:none; padding: 18px; animation: pageIn .35s ease both; }
    .page.active { display:block; }
    @keyframes pageIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }

    .card, .kpi-card { transition: transform .18s ease, box-shadow .18s ease; }
    .card:hover, .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 18px 30px rgba(0,0,0,.08); }
    .kpi-card { cursor: pointer; user-select:none; }

    .open-panel-item { cursor:pointer; transition: transform .15s ease, background .15s ease; }
    .open-panel-item:hover { background: #f9fafb; transform: translateY(-1px); }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar collapsed" id="sidebar">
      <div class="sidebar-toggle" onclick="toggleSidebar()" title="Menu">‚ò∞</div>
      <div class="logo">
        <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/cacca5b9-29da-4402-ace7-419b369140a7" alt="Porto Mais" />
        <div>
          <h1>Gerenciador<br/>de Eventos</h1>
          <div class="text-xs font-semibold text-white/70">Apresenta√ß√£o mensal</div>
        </div>
      </div>

      <nav class="menu">
        <div class="item active" id="nav-data" onclick="go('data')"><span>üìù</span><span class="txt">Editar dados</span></div>
        <div class="item" id="nav-dash" onclick="go('dash')"><span>üìä</span><span class="txt">Dashboard</span></div>
        <div class="item" id="nav-juridico" onclick="go('juridico')"><span>‚öñÔ∏è</span><span class="txt">Jur√≠dico (3¬∫ causador)</span></div>
        <div class="item" id="nav-compare" onclick="go('compare')"><span>üìà</span><span class="txt">Comparar meses</span></div>

        <div class="mt-2 px-2 text-xs font-extrabold tracking-wider text-white/60">A√á√ïES</div>
        <div class="item" onclick="openImportModal()"><span>üìã</span><span class="txt">Colar Excel</span></div>
        <div class="item" onclick="exportData()"><span>üíæ</span><span class="txt">Exportar CSV</span></div>
        <div class="item" onclick="exportAllBackup()"><span>üóÑÔ∏è</span><span class="txt">Gerar backup</span></div>
        <div class="item" onclick="importBackupFile()"><span>üìÇ</span><span class="txt">Restaurar backup</span></div>
      </nav>

      <div class="footer">
        <div class="flex items-center justify-between">
          <span class="text-xs text-white/70">M√™s selecionado</span>
          <span class="badge" id="badge-month">ATUAL</span>
        </div>
        <button class="btn btn-warning" onclick="showStorageInfo()">üíæ Armazenamento</button>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="flex items-center gap-3">
          <div class="text-lg font-extrabold text-gray-800" id="page-title">Editar dados</div>
          <div class="text-xs font-bold text-gray-500" id="page-sub">Tabela principal do m√™s atual</div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <div class="month-selector" style="margin:0; padding:0; box-shadow:none; background:transparent;">
            <select id="month-switch" onchange="handleMonthSwitch()"></select>
          </div>
          <button class="btn btn-primary" onclick="saveCurrentMonthWithChecks()">üíæ Salvar m√™s</button>
          <button class="btn btn-success" onclick="updateDashboard(); go('dash')">üìä Atualizar dashboard</button>
        </div>
      </div>

      <section id="page-data" class="page active">
        <div class="alert alert-info">üí° <b>Dicas:</b> ‚ÄúEVENTO TIPO‚Äù √© o tipo do dano (VIDROS, ROUBO/FURTO...). J√° ‚ÄúCAUSADOR‚Äù define quem causou (TERCEIRO/ASSOCIADO). Jur√≠dico usa CAUSADOR.</div>
        <div class="card"><div id="spreadsheet"></div></div>
      </section>

      <section id="page-dash" class="page">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
          <div class="kpi-card border-blue-500" onclick="kpiFilter('all')"><p class="kpi-label">Total de Eventos</p><p class="kpi-value text-blue-600" id="kpi-total">0</p><p class="kpi-sub">Todos registros</p></div>
          <div class="kpi-card border-purple-500" onclick="kpiFilter('roubo')"><p class="kpi-label">Roubo / Furto</p><p class="kpi-value text-purple-600" id="kpi-roubo">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-cyan-500" onclick="kpiFilter('vidros')"><p class="kpi-label">Vidros</p><p class="kpi-value text-cyan-600" id="kpi-vidros">0</p><p class="kpi-sub">Filtro: EVENTO TIPO</p></div>
          <div class="kpi-card border-yellow-500" onclick="kpiFilter('acordos')"><p class="kpi-label">Acordos</p><p class="kpi-value text-yellow-600" id="kpi-acordos">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-green-500" onclick="kpiFilter('finalizados')"><p class="kpi-label">Finalizados</p><p class="kpi-value text-green-600" id="kpi-finalizados">0</p><p class="kpi-sub">Clique para filtrar</p></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="kpi-card border-slate-500" onclick="kpiFilter('terceiroCausador')"><p class="kpi-label">3¬∫ causador</p><p class="kpi-value text-slate-700" id="kpi-terc-causador">0</p><p class="kpi-sub">Filtro: CAUSADOR</p></div>
          <div class="kpi-card border-indigo-500" onclick="kpiFilter('jurEm')"><p class="kpi-label">Jur√≠dico: Em cobran√ßa</p><p class="kpi-value text-indigo-600" id="kpi-jur-em">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-emerald-500" onclick="kpiFilter('jurRec')"><p class="kpi-label">Jur√≠dico: Recuperado</p><p class="kpi-value text-emerald-600" id="kpi-jur-rec">0</p><p class="kpi-sub">Clique para filtrar</p></div>
          <div class="kpi-card border-rose-500" onclick="kpiFilter('jurNao')"><p class="kpi-label">Jur√≠dico: N√£o cobrar</p><p class="kpi-value text-rose-600" id="kpi-jur-nao">0</p><p class="kpi-sub">Encerrar sem cobran√ßa</p></div>
          <div class="kpi-card border-amber-500" onclick="kpiFilter('jurValor')"><p class="kpi-label">Valor a recuperar</p><p class="kpi-value text-amber-600" id="kpi-jur-valor">R$ 0,00</p><p class="kpi-sub">Clique para filtrar</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
          <div class="card"><h3 class="font-bold text-gray-700 mb-3">‚öñÔ∏è Status Jur√≠dico</h3><div id="chart-juridico" style="height: 320px;"></div></div>
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-bold text-gray-700">üìå Em aberto (eventos)</h3>
              <button class="btn btn-primary" onclick="kpiFilter('open')">Ver na planilha</button>
            </div>
            <div id="open-panel" class="text-sm text-gray-700"></div>
          </div>
        </div>
      </section>

      <section id="page-juridico" class="page">
        <div class="card mb-4">
          <h2 class="text-2xl font-extrabold text-gray-800">‚öñÔ∏è Jur√≠dico (3¬∫ causador)</h2>
          <p class="text-sm text-gray-600 mt-1">Somente eventos em que <b>CAUSADOR = TERCEIRO</b>. EVENTO TIPO pode ser VIDROS, ROUBO/FURTO etc.</p>
        </div>

        <div class="card">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
            <div class="text-sm font-bold text-gray-700">Somente registros com CAUSADOR = TERCEIRO</div>
            <button class="btn btn-primary" onclick="filterJuridicoView()">üîé Atualizar lista</button>
          </div>
          <div id="juridico-table" class="text-sm"></div>
        </div>
      </section>

      <section id="page-compare" class="page">
        <div class="card mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà Compara√ß√£o de Meses</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Selecione o M√™s 1:</label>
              <select id="month1-select" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                <option value="">-- Selecione um m√™s --</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Selecione o M√™s 2:</label>
              <select id="month2-select" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                <option value="">-- Selecione um m√™s --</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="compareMonths()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">üîÑ Comparar</button>
            </div>
          </div>

          <div id="compare-results" class="hidden"></div>
        </div>
      </section>

      <div id="importModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
          <div class="p-4 border-b-2 border-[#002B5C] flex justify-between items-center bg-gradient-to-r from-[#002B5C] to-[#003d7a] rounded-t-lg">
            <h3 class="font-bold text-lg text-white">üìã Importar Dados do Excel</h3>
            <button onclick="closeImportModal()" class="text-white hover:text-orange-300 font-bold text-2xl">&times;</button>
          </div>
          <div class="p-4 flex-1 overflow-y-auto">
            <div class="bg-blue-50 border-l-4 border-[#002B5C] p-3 mb-4 rounded text-xs">
              <p class="font-bold text-[#002B5C] mb-2">‚úÖ PASSO A PASSO:</p>
              <ol class="list-decimal list-inside text-gray-700 space-y-1">
                <li>No Excel, selecione <b>SEM O CABE√áALHO</b> (apenas os dados)</li>
                <li>Pressione <b>Ctrl+C</b> para copiar</li>
                <li>Cole na caixa abaixo <b>Ctrl+V</b></li>
                <li>Clique em <b>Processar Dados</b></li>
              </ol>
            </div>
            <p class="text-xs font-bold text-gray-700 mb-2">üìç ORDEM EXATA DAS COLUNAS (12):</p>
            <div class="bg-gray-100 p-3 rounded text-xs font-mono text-gray-800 mb-4 overflow-x-auto">
              1.Assoc | 2.Benefici√°rio | 3.Ve√≠culo | 4.Placa | 5.Data | 6.Oficina | 7.Cota | 8.MO | 9.Pe√ßas | 10.Outras | 11.TOTAL | 12.Situa√ß√£o
            </div>
            <textarea id="pasteArea" class="w-full border-2 border-[#002B5C] rounded p-3 text-xs font-mono h-48 resize-none" placeholder="Cole seus dados aqui (Ctrl+V)..."></textarea>
          </div>
          <div class="p-4 border-t-2 border-[#002B5C] bg-gray-50 rounded-b-lg text-right">
            <button onclick="processPaste()" class="bg-[#FF6B35] hover:bg-[#e55a24] text-white px-6 py-2 rounded font-bold text-sm">‚úîÔ∏è Processar Dados</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    const JURIDICO_STATUS = ['N√ÉO INICIADO','EM COBRAN√áA','COBRADO','ACORDO','N√ÉO COBRAR','RECUPERADO'];
    const CAUSADOR_OPTS = ['ASSOCIADO','TERCEIRO','N√ÉO IDENTIFICADO'];
    const EVENTO_TIPO_OPTS = ['VIDROS','ROUBO/FURTO','COLIS√ÉO','OUTROS'];

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;

    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('collapsed'); }

    function monthKey(y, m){ return `month_${y}_${String(m).padStart(2,'0')}`; }
    function monthLabel(y,m){ const d = new Date(y, m-1); return d.toLocaleString('pt-BR',{month:'long',year:'numeric'}).toUpperCase(); }
    function setBadge(){ const b = document.getElementById('badge-month'); if(b) b.innerText = monthLabel(currentYear, currentMonth); }

    function go(page){
      const pages = ['data','dash','juridico','compare'];
      pages.forEach(p=>{
        const el = document.getElementById('page-'+p);
        const nav = document.getElementById('nav-'+p);
        if(el) el.classList.toggle('active', p===page);
        if(nav) nav.classList.toggle('active', p===page);
      });
      const titleMap = { data:'Editar dados', dash:'Dashboard', juridico:'Jur√≠dico (3¬∫ causador)', compare:'Comparar meses' };
      const subMap = { data:'Tabela principal do m√™s selecionado', dash:'KPIs e gr√°ficos do m√™s selecionado', juridico:'Cobran√ßa e status jur√≠dico (3¬∫ causador)', compare:'Compara√ß√£o de custos e oficinas entre meses' };
      document.getElementById('page-title').innerText = titleMap[page] || 'Gerenciador';
      document.getElementById('page-sub').innerText = subMap[page] || '';
      if(page==='dash') updateDashboard();
      if(page==='compare') updateCompareSelects();
      if(page==='juridico') filterJuridicoView();
      if(page==='data') setTimeout(()=>hot.render(), 50);
    }

    function getSavedMonths(){
      const months = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('month_')){ try{ months.push({ key:k, ...JSON.parse(localStorage.getItem(k)) }); }catch(e){} }
      }
      return months.sort((a,b)=> (b.year-a.year) || (b.month-a.month));
    }

    function fillMonthSwitch(){
      const sel = document.getElementById('month-switch');
      const months = getSavedMonths();
      const keyNow = monthKey(currentYear, currentMonth);
      const existsNow = months.some(m=>m.key===keyNow);
      const list = existsNow ? months : [{key:keyNow, year:currentYear, month:currentMonth, monthLabel:monthLabel(currentYear,currentMonth), data: hot ? hot.getData(): []}, ...months];
      sel.innerHTML = list.map(m=>`<option value="${m.key}">${m.monthLabel || monthLabel(m.year,m.month)}</option>`).join('');
      sel.value = keyNow;
    }

    function handleMonthSwitch(){
      const key = document.getElementById('month-switch').value;
      const md = JSON.parse(localStorage.getItem(key) || 'null');
      if(md && md.data){ currentYear = md.year; currentMonth = md.month; hot.loadData(md.data); setBadge(); updateDashboard(); }
    }

    function saveCurrentMonth(){
      const data = hot.getData();
      const k = monthKey(currentYear, currentMonth);
      const md = { year: currentYear, month: currentMonth, monthLabel: monthLabel(currentYear,currentMonth), saveDate: new Date().toLocaleString('pt-BR'), data };
      localStorage.setItem(k, JSON.stringify(md));
      return md;
    }

    function normalizePlaca(v){ return (v||'').toString().toUpperCase().replace(/[^A-Z0-9]/g,'').trim(); }
    function isOpenStatus(status){ const s = (status||'').toString().toUpperCase().trim(); return !(s==='FINALIZADO' || s==='NEGADO'); }

    // EVENTO TIPO is the official source for category filters
    function isVidroRow(r){ return (r[17]||'').toString().toUpperCase().trim()==='VIDROS'; }
    function isRouboRow(r){ return (r[17]||'').toString().toUpperCase().trim()==='ROUBO/FURTO'; }
    function isAcordoRow(r){ return (r[11]||'').toString().toUpperCase().trim()==='ACORDO'; }
    function isFinalizadoRow(r){ return (r[11]||'').toString().toUpperCase().trim()==='FINALIZADO'; }

    function isTerceiroCausadorRow(r){ return (r[12]||'').toString().toUpperCase().trim()==='TERCEIRO'; }
    function isJuridicoStatus(r, statuses){ return statuses.includes((r[13]||'').toString().toUpperCase().trim()); }

    function applyFilter(predicate){
      const data = hot.getData() || [];
      const matches = [];
      for(let i=0;i<data.length;i++){
        const r = data[i];
        if(!r[0]) continue;
        if(predicate(r, i)) matches.push(i);
      }
      if(!matches.length){ Swal.fire('Sem resultados','Nenhuma linha encontrada para esse filtro.','info'); return; }
      go('data');
      setTimeout(()=>{
        const filters = hot.getPlugin('filters');
        try{ filters.clearConditions(); filters.filter(); }catch(e){}
        hot.render();
        hot.selectCell(matches[0], 0);
        hot.scrollViewportTo(matches[0], 0);
        Swal.fire({ toast:true, position:'top-end', timer:1800, showConfirmButton:false, icon:'success', title:`Filtro aplicado: ${matches.length} linha(s)` });
      }, 120);
    }

    function kpiFilter(key){
      if(key==='all') return applyFilter(()=>true);
      if(key==='vidros') return applyFilter(r=>isVidroRow(r));
      if(key==='roubo') return applyFilter(r=>isRouboRow(r));
      if(key==='acordos') return applyFilter(r=>isAcordoRow(r));
      if(key==='finalizados') return applyFilter(r=>isFinalizadoRow(r));
      if(key==='open') return applyFilter(r=>isOpenStatus(r[11]));
      if(key==='terceiroCausador') return applyFilter(r=>isTerceiroCausadorRow(r));
      if(key==='jurEm') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['EM COBRAN√áA','COBRADO']));
      if(key==='jurRec') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['RECUPERADO']));
      if(key==='jurNao') return applyFilter(r=>isTerceiroCausadorRow(r) && isJuridicoStatus(r,['N√ÉO COBRAR']));
      if(key==='jurValor') return applyFilter(r=>isTerceiroCausadorRow(r) && ((parseFloat(r[15])||0)>0));
    }

    function buildOpenPanel(openRows){
      const wrap = document.getElementById('open-panel');
      if(!wrap) return;
      if(!openRows.length){ wrap.innerHTML = '<div class="text-gray-400">Sem eventos em aberto neste m√™s.</div>'; return; }
      wrap.innerHTML = `
        <div class="space-y-2">
          ${openRows.slice(0,12).map(item=>{
            const v = item.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            return `
              <div class="open-panel-item border rounded-lg p-2 bg-white" onclick="openRow(${item.rowIndex})">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold">${item.placa || '-'} <span class="text-xs text-gray-400">(${item.status || '-'})</span></div>
                  <div class="text-sm font-bold text-gray-800">${v}</div>
                </div>
                <div class="text-xs text-gray-600 mt-1">${item.eventoTipo || ''} ‚Ä¢ ${item.veiculo || ''} ‚Ä¢ ${item.oficina || ''}</div>
              </div>`;
          }).join('')}
          ${openRows.length>12 ? `<div class="text-xs text-gray-500">Mostrando 12 de ${openRows.length}. Use ‚ÄúVer na planilha‚Äù para ver todos.</div>` : ''}
        </div>`;
    }

    function openRow(rowIndex){ go('data'); setTimeout(()=>{ hot.selectCell(rowIndex, 0); hot.scrollViewportTo(rowIndex, 0); }, 120); }

    function findOpenPlateInOtherMonths(placa){
      const p = normalizePlaca(placa);
      if(!p) return null;
      const months = getSavedMonths();
      for(const m of months){
        if(m.year===currentYear && m.month===currentMonth) continue;
        const rows = m.data || [];
        for(const r of rows){
          const placaR = normalizePlaca(r[3]);
          const st = r[11];
          if(placaR===p && isOpenStatus(st)) return { monthLabel: m.monthLabel || monthLabel(m.year,m.month), key: m.key, status: st };
        }
      }
      return null;
    }

    async function saveCurrentMonthWithChecks(){
      const rows = hot.getData();
      const duplicates = [];
      for(const r of rows){ if(!r[0]) continue; const found = findOpenPlateInOtherMonths(r[3]); if(found) duplicates.push({ placa: normalizePlaca(r[3]), found }); }
      if(duplicates.length){
        const first = duplicates[0];
        const html = `<div class="text-left text-sm">
          <p><b>Encontramos placa(s) j√° em aberto em outro m√™s.</b></p>
          <p class="mt-2">Exemplo: <b>${first.placa}</b> est√° em <b>${first.found.monthLabel}</b> (status: ${first.found.status||'-'}).</p>
          <p class="mt-2 text-xs text-gray-500">O sistema n√£o vai duplicar para outro m√™s. V√° no m√™s onde est√° aberto e finalize/negue antes.</p>
        </div>`;
        const res = await Swal.fire({ title: '‚ö†Ô∏è Placa j√° em aberto', html, icon: 'warning', showCancelButton: true, confirmButtonText: 'Ir para o m√™s', cancelButtonText: 'Cancelar' });
        if(res.isConfirmed){
          const md = JSON.parse(localStorage.getItem(first.found.key));
          if(md){ currentYear = md.year; currentMonth = md.month; hot.loadData(md.data); fillMonthSwitch(); setBadge(); go('data'); }
        }
        return;
      }
      saveCurrentMonth(); fillMonthSwitch(); setBadge(); Swal.fire('‚úÖ Salvo!', 'M√™s salvo com sucesso.', 'success');
    }

    function exportAllBackup(){
      const months = getSavedMonths();
      if(!months.length){ Swal.fire('‚ùå Nenhum Backup','Nenhum m√™s salvo ainda.','error'); return; }
      const backup = { exportDate: new Date().toLocaleString('pt-BR'), totalMonths: months.length, months: months.map(m=>({monthLabel:m.monthLabel, year:m.year, month:m.month, saveDate:m.saveDate, data:m.data})) };
      const blob = new Blob([JSON.stringify(backup,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_portoMais_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importBackupFile(){
      const i = document.createElement('input');
      i.type='file'; i.accept='.json';
      i.onchange=(e)=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=(ev)=>{
          try{
            const d=JSON.parse(ev.target.result);
            if(!d.months) throw new Error('Inv√°lido');
            d.months.forEach(m=> localStorage.setItem(monthKey(m.year, m.month), JSON.stringify(m)));
            const first=d.months[0];
            currentYear=first.year; currentMonth=first.month;
            hot.loadData(first.data);
            fillMonthSwitch(); setBadge(); updateDashboard();
            Swal.fire('‚úÖ Carregado!','Backup restaurado.','success');
          }catch(err){ Swal.fire('Erro','Falha ao importar: '+err.message,'error'); }
        };
        r.readAsText(f);
      };
      i.click();
    }

    function showStorageInfo(){
      const months = getSavedMonths();
      let total=0; months.forEach(m=>{ total += JSON.stringify(m).length; });
      const kb=(total/1024).toFixed(2);
      Swal.fire('üíæ Armazenamento', `Meses salvos: ${months.length}<br/>Tamanho aproximado: ${kb} KB`, 'info');
    }

    const initialData = [["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""]];

    const container = document.getElementById('spreadsheet');
    const hot = new Handsontable(container, {
      data: initialData,
      colHeaders: [
        'ASSOCIA√á√ÉO','BENEFICI√ÅRIO','VE√çCULO','PLACA','DATA OFICINA','OFICINA',
        'COTA','M√ÉO DE OBRA','PE√áAS','OUTRAS DESPESAS','GASTOS TOTAIS','SITUA√á√ÉO',
        'CAUSADOR','JUR√çDICO STATUS','DT ENVIO JUR√çDICO','VALOR A RECUPERAR','OBS JUR√çDICO',
        'EVENTO TIPO'
      ],
      columns: [
        { type:'text' },
        { type:'dropdown', source:['ASSOCIADO','TERCEIRO'] },
        { type:'text' },
        { type:'text' },
        { type:'date', dateFormat:'DD/MM/YYYY' },
        { type:'text' },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' }, readOnly:true },
        { type:'dropdown', source:['FINALIZADO','EM ANDAMENTO','NEGADO','PENDENTE','ACORDO'] },
        { type:'dropdown', source: CAUSADOR_OPTS },
        { type:'dropdown', source: JURIDICO_STATUS },
        { type:'date', dateFormat:'DD/MM/YYYY' },
        { type:'numeric', numericFormat:{ pattern:'0,0.00', culture:'pt-BR' } },
        { type:'text' },
        { type:'dropdown', source: EVENTO_TIPO_OPTS }
      ],
      rowHeaders: true,
      width:'100%',
      height:'65vh',
      licenseKey:'non-commercial-and-evaluation',
      minSpareRows: 1,
      filters:true,
      dropdownMenu:true,
      manualColumnResize:true,
      autoWrapRow:true,
      stretchH:'all',
      afterChange(changes, source){
        if(!changes || source==='source') return;
        changes.forEach(([row, col])=>{
          if([6,7,8,9].includes(col)){
            const cota=parseFloat(this.getDataAtCell(row,6))||0;
            const mao=parseFloat(this.getDataAtCell(row,7))||0;
            const pecas=parseFloat(this.getDataAtCell(row,8))||0;
            const outras=parseFloat(this.getDataAtCell(row,9))||0;
            this.setDataAtCell(row,10, cota+mao+pecas+outras, 'source');
          }
        });
        saveCurrentMonth(); fillMonthSwitch(); setBadge();
      }
    });

    function openImportModal(){ document.getElementById('importModal').classList.remove('hidden'); }
    function closeImportModal(){ document.getElementById('importModal').classList.add('hidden'); }

    function inferEventoTipoFromRow12(base12){
      const veic = (base12[2]||'').toString().toUpperCase();
      const ofi = (base12[5]||'').toString().toUpperCase();
      const sit = (base12[11]||'').toString().toUpperCase();
      if(veic.includes('ROUBO') || veic.includes('FURTO') || ofi.includes('INDENIZA') || sit.includes('INDENIZA')) return 'ROUBO/FURTO';
      if(veic.includes('VIDRO') || ofi.includes('VIDRO') || ofi.includes('CARGLASS') || ofi.includes('AUTO GLASS') || sit.includes('VIDRO')) return 'VIDROS';
      return 'OUTROS';
    }

    function processPaste(){
      const raw = (document.getElementById('pasteArea').value||'').trim();
      if(!raw){ Swal.fire('‚ö†Ô∏è Aten√ß√£o','Cole os dados primeiro.','warning'); return; }

      const rows = raw.split('\n').map(line=>{
        let parts = line.split('\t');
        if(parts.length===1) parts=line.split(',');
        if(parts.length===1) parts=line.split(/\s{2,}/);
        return parts.map(p=>p.trim());
      });

      const normalized = rows.map(r=>{
        const base = r.slice(0,12);
        while(base.length<12) base.push('');
        const eventoTipo = inferEventoTipoFromRow12(base);
        const extra = ['N√ÉO IDENTIFICADO','N√ÉO INICIADO','','','', eventoTipo];
        return [...base, ...extra];
      });

      const kept=[];
      const blocked=[];
      for(const r of normalized){
        const found = findOpenPlateInOtherMonths(r[3]);
        if(found) blocked.push({placa: normalizePlaca(r[3]), month: found.monthLabel});
        else kept.push(r);
      }

      hot.populateFromArray(0,0, kept);
      closeImportModal();
      document.getElementById('pasteArea').value='';
      saveCurrentMonth(); fillMonthSwitch(); setBadge();

      if(blocked.length) Swal.fire('‚ö†Ô∏è Alguns registros foram bloqueados', `${blocked.length} placa(s) j√° estavam em aberto em outro m√™s e n√£o foram importadas.`, 'warning');
      else Swal.fire('‚úÖ Sucesso!', `${kept.length} linhas importadas com sucesso!`, 'success');
    }

    function exportData(){ const exportPlugin = hot.getPlugin('exportFile'); exportPlugin.downloadFile('csv', { filename:'Eventos_PortoMais', columnHeaders:true, bom:true }); }

    function updateDashboard(){
      let data=[]; try{ data = hot.getData(); }catch(e){}

      let tEv=0, cVid=0, cRou=0;
      let $Vid=0, $Rou=0;
      let jurEm=0, jurRec=0, jurNao=0, jurValor=0, tercCaus=0;
      let jurStatusCounts = {};
      let openRows=[];

      if(data && data.length){
        data.forEach((r, idx)=>{
          if(!r[0]) return;
          tEv++;

          const val = (parseFloat(r[7])||0) + (parseFloat(r[8])||0) + (parseFloat(r[9])||0);

          if(isRouboRow(r)){ cRou++; $Rou+=val; }
          if(isVidroRow(r)){ cVid++; $Vid+=val; }

          if(isOpenStatus(r[11])){
            openRows.push({ rowIndex: idx, placa: normalizePlaca(r[3]), veiculo: r[2]||'', oficina: r[5]||'', status: r[11]||'', valor: (parseFloat(r[10])||0), eventoTipo: r[17]||'' });
          }

          if(isTerceiroCausadorRow(r)){
            const jur = (r[13]||'').toString().toUpperCase().trim();
            const valRec = parseFloat(r[15]) || 0;
            tercCaus++;
            if(jur) jurStatusCounts[jur] = (jurStatusCounts[jur]||0)+1;
            if(jur==='EM COBRAN√áA' || jur==='COBRADO') jurEm++;
            if(jur==='RECUPERADO') jurRec++;
            if(jur==='N√ÉO COBRAR') jurNao++;
            jurValor += valRec;
          }
        });
      }

      const el=(i,v)=>{ const e=document.getElementById(i); if(e) e.innerText=v; };
      const m=(v)=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

      el('kpi-total', tEv);
      el('kpi-roubo', cRou);
      el('kpi-vidros', cVid);
      el('kpi-custo-roubo', m($Rou));
      el('kpi-custo-vidros', m($Vid));

      el('kpi-terc-causador', tercCaus);
      el('kpi-jur-em', jurEm);
      el('kpi-jur-rec', jurRec);
      el('kpi-jur-nao', jurNao);
      el('kpi-jur-valor', m(jurValor));

      buildOpenPanel(openRows.sort((a,b)=> (b.valor-a.valor)));

      try{
        const labs = Object.keys(jurStatusCounts);
        const vals = Object.values(jurStatusCounts);
        Plotly.newPlot('chart-juridico',[{ labels: labs.length? labs : ['Sem dados'], values: labs.length? vals : [1], type:'pie', hole:.45 }],{ margin:{t:10,b:10,l:10,r:10} },{responsive:true});
      }catch(e){}
    }

    function filterJuridicoView(){
      const data = hot.getData() || [];
      const rows = data.map((r, idx)=>({r, idx})).filter(x=> isTerceiroCausadorRow(x.r));
      const wrap = document.getElementById('juridico-table');
      if(!wrap) return;
      if(!rows.length){ wrap.innerHTML = '<div class="text-gray-400">Sem eventos com CAUSADOR = TERCEIRO neste m√™s.</div>'; return; }
      const head = ['PLACA','EVENTO TIPO','BENEFICI√ÅRIO','VE√çCULO','SITUA√á√ÉO','STATUS JUR√çDICO','VALOR RECUP.','OBS'];
      wrap.innerHTML = `
        <div class="overflow-auto">
          <table class="min-w-full text-xs">
            <thead><tr>${head.map(h=>`<th class="text-left p-2 bg-gray-100 border">${h}</th>`).join('')}</tr></thead>
            <tbody>
              ${rows.map(x=>{
                const r = x.r;
                const placa = normalizePlaca(r[3]);
                const valRec = parseFloat(r[15])||0;
                return `<tr class="border-b hover:bg-gray-50 open-panel-item" onclick="openRow(${x.idx})">
                  <td class="p-2 font-extrabold">${placa||''}</td>
                  <td class="p-2 font-bold">${(r[17]||'')}</td>
                  <td class="p-2">${(r[1]||'')}</td>
                  <td class="p-2">${(r[2]||'')}</td>
                  <td class="p-2">${(r[11]||'')}</td>
                  <td class="p-2 font-bold">${(r[13]||'')}</td>
                  <td class="p-2">${valRec? valRec.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : ''}</td>
                  <td class="p-2">${(r[16]||'')}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function updateCompareSelects(){
      const months = getSavedMonths();
      const html = months.map(m=> `<option value="${m.key}">${m.monthLabel||monthLabel(m.year,m.month)}</option>`).join('');
      document.getElementById('month1-select').innerHTML = '<option value="">-- Selecione um m√™s --</option>' + html;
      document.getElementById('month2-select').innerHTML = '<option value="">-- Selecione um m√™s --</option>' + html;
    }

    function compareMonths(){ Swal.fire('Em breve','A compara√ß√£o detalhada ser√° reintroduzida ap√≥s consolidar as novas colunas.','info'); }

    setTimeout(()=>{ setBadge(); saveCurrentMonth(); fillMonthSwitch(); updateCompareSelects(); updateDashboard(); }, 200);
  </script>
</body>
</html>
